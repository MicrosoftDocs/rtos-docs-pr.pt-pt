---
title: Capítulo 3 - Descrição da cache de serviço interno
description: 'O módulo NetX Duo mDNS gere duas caches de serviços internos: a cache de serviço local e a cache de serviço de pares.'
author: philmea
ms.author: philmea
ms.date: 07/09/2020
ms.topic: article
ms.service: rtos
ms.openlocfilehash: 007f1080a076730cfbcdedc9f063ac0c427a414c
ms.sourcegitcommit: e3d42e1f2920ec9cb002634b542bc20754f9544e
ms.translationtype: MT
ms.contentlocale: pt-PT
ms.lasthandoff: 03/22/2021
ms.locfileid: "104825915"
---
# <a name="chapter-3---description-of-internal-service-cache"></a><span data-ttu-id="d063a-103">Capítulo 3 - Descrição da cache de serviço interno</span><span class="sxs-lookup"><span data-stu-id="d063a-103">Chapter 3 - Description of internal service cache</span></span>

<span data-ttu-id="d063a-104">O módulo NetX Duo mDNS gere duas caches de serviços internos: a cache de serviço local e a cache de serviço de pares.</span><span class="sxs-lookup"><span data-stu-id="d063a-104">NetX Duo mDNS module manages two internal services caches: the local service cache, and the peer service cache.</span></span> <span data-ttu-id="d063a-105">O serviço local armazena a Resource Records relacionada com os serviços oferecidos por aplicações em execução no nó.</span><span class="sxs-lookup"><span data-stu-id="d063a-105">The local service cache stores Resource Records related to services offered by applications running on the node.</span></span> <span data-ttu-id="d063a-106">Para consultas recebidas, se a pergunta corresponder ao serviço oferecido, as respostas do mDNS com respostas armazenadas na cache de serviço local.</span><span class="sxs-lookup"><span data-stu-id="d063a-106">For incoming queries, if the question matches the service offered, mDNS responses with answers stored in the local service cache.</span></span> <span data-ttu-id="d063a-107">Os pedidos registam serviços através da *nx_mdns_service_add da API()*.</span><span class="sxs-lookup"><span data-stu-id="d063a-107">Applications register services by calling the API *nx_mdns_service_add()*.</span></span> <span data-ttu-id="d063a-108">Para remover os serviços, as aplicações utilizam a *API nx_mdns_service_delete()* que por sua vez enviará mensagens de "adeus" antes de remover as entradas correspondentes na cache de serviço local.</span><span class="sxs-lookup"><span data-stu-id="d063a-108">To remove services, applications use the API *nx_mdns_service_delete()*, which will in turn send "goodbye" messages before removing the corresponding entries in the local service cache.</span></span>

<span data-ttu-id="d063a-109">Quando um serviço é adicionado, o mDNS mantém pelo menos 3 Registos de Recursos na cache de serviço local: SRV, PTR e TXT.</span><span class="sxs-lookup"><span data-stu-id="d063a-109">When a service is added, mDNS maintains at least 3 Resource Records in the local service cache: SRV, PTR, and TXT.</span></span> <span data-ttu-id="d063a-110">O Registo adicional de Recursos PTR pode ser adicionado se o tipo de serviço incluir o subtipo.</span><span class="sxs-lookup"><span data-stu-id="d063a-110">Additional PTR Resource Record may be added if the service type includes subtype.</span></span> <span data-ttu-id="d063a-111">Por exemplo, uma aplicação regista um serviço:</span><span class="sxs-lookup"><span data-stu-id="d063a-111">For example, an application registers a service:</span></span>

```
*name*._*subtype*._sub._*type*._tcp.local,
```

<span data-ttu-id="d063a-112">dois Registos de Recursos PTR são adicionados à cache de serviço local, um para</span><span class="sxs-lookup"><span data-stu-id="d063a-112">two PTR Resource Records are added to the local service cache, one for</span></span>

```
“*_subtype._*sub*._type._*tcp.local *PTR name.type._*tcp*.*local”
```

<span data-ttu-id="d063a-113">e o outro para</span><span class="sxs-lookup"><span data-stu-id="d063a-113">and the other one for</span></span>

```
*“_type._*tcp*.*local *PTR name.type._*tcp*.*local”.
```

<span data-ttu-id="d063a-114">A cache de serviço de pares contém mDNS Resource Records recebidos de nós vizinhos.</span><span class="sxs-lookup"><span data-stu-id="d063a-114">The peer service cache contains mDNS Resource Records received from neighboring nodes.</span></span> <span data-ttu-id="d063a-115">o módulo mDNS recolhe Registos de Recursos anunciados por outros nós na rede e armazena a informação recebida na cache de serviço de pares.</span><span class="sxs-lookup"><span data-stu-id="d063a-115">mDNS module collects Resource Records advertised by other nodes on the network, and stores the received information in the peer service cache.</span></span> <span data-ttu-id="d063a-116">Quando as consultas de aplicação para obter informações como endereços IPv4 ou IPv6 de anfitrião, o mDNS procura a cache de serviço de pares para obter respostas em cache local.</span><span class="sxs-lookup"><span data-stu-id="d063a-116">When application queries for information such as host IPv4 or IPv6 addresses, mDNS searches the peer service cache for locally cached responses.</span></span> <span data-ttu-id="d063a-117">Quando as consultas de aplicação para serviços oferecidos pelos pares, o mDNS procura através da cache registos de endereços PTR, SRV, TXT e IPvv4/IPv6.</span><span class="sxs-lookup"><span data-stu-id="d063a-117">When application queries for services offered by peers, mDNS searches through the cache for related PTR, SRV, TXT, and IPv4/IPv6 address records.</span></span> <span data-ttu-id="d063a-118">A cache de serviço de pares também armazena consultas enviadas para o nó.</span><span class="sxs-lookup"><span data-stu-id="d063a-118">The peer service cache also stores queries sent to the node.</span></span> <span data-ttu-id="d063a-119">Por exemplo, um pedido pode solicitar um determinado serviço ligando *nx_mdns_service_one_shot_query.*</span><span class="sxs-lookup"><span data-stu-id="d063a-119">For example, an application may request a particular service by calling *nx_mdns_service_one_shot_query.*</span></span> <span data-ttu-id="d063a-120">Se o serviço não for encontrado na cache de serviço de pares, o mDNS cria questões de consulta (PTR, SRV e TXT) na cache de serviço de pares.</span><span class="sxs-lookup"><span data-stu-id="d063a-120">If the service is not found in the peer service cache, mDNS creates query questions (PTR, SRV, and TXT) in the peer service cache.</span></span> <span data-ttu-id="d063a-121">Estas questões de consulta serão enviadas periodicamente para a rede até que o serviço seja resolvido, ou o tempo limite. Da mesma forma, o pedido pode utilizar a *API nx_mdns_service_continous_query()* para solicitar um determinado serviço durante um longo período de tempo (a aplicação cancela uma consulta contínua previamente emitida através da *nx_mdns_service_query_stop da API().*</span><span class="sxs-lookup"><span data-stu-id="d063a-121">These query questions will be sent to the network periodically till the service is resolved, or times out. Similar, the application may use the API *nx_mdns_service_continous_query()* to request a particular service over a long period of time (application cancels a previously issued continuous query by using the API *nx_mdns_service_query_stop()* ).</span></span> <span data-ttu-id="d063a-122">Para procurar um determinado serviço na cache de serviço de pares sem enviar consultas para a rede, as aplicações podem utilizar o *nx_mdns_serivce_lookup API().*</span><span class="sxs-lookup"><span data-stu-id="d063a-122">To search for a particular service in the peer service cache without sending queries to the network, applications can use the API *nx_mdns_serivce_lookup().*</span></span> <span data-ttu-id="d063a-123">Esta API apenas procura os registos de recursos na cache de serviço de pares.</span><span class="sxs-lookup"><span data-stu-id="d063a-123">This API only searches the resource records in the peer service cache.</span></span>

<span data-ttu-id="d063a-124">Cada Registo de Recursos é armazenado numa estrutura de dados *NX_MDNS_RR* nas caches de serviço.</span><span class="sxs-lookup"><span data-stu-id="d063a-124">Each Resource Record is stored in a data structure *NX_MDNS_RR* in the service caches.</span></span> <span data-ttu-id="d063a-125">As cadeias em Registos de Recursos são de comprimento variável, portanto não são armazenadas na estrutura *NX_MDNS_RR.*</span><span class="sxs-lookup"><span data-stu-id="d063a-125">Strings in Resource Records are variable length, therefore are not stored in the *NX_MDNS_RR* structure.</span></span> <span data-ttu-id="d063a-126">O Registo de Recursos contém um ponteiro para o local de memória real onde a cadeia é armazenada.</span><span class="sxs-lookup"><span data-stu-id="d063a-126">The Resource Record contains a pointer to the actual memory location where the string is stored.</span></span> <span data-ttu-id="d063a-127">A tabela de cordas e os Registos de Recursos partilham a cache de serviço.</span><span class="sxs-lookup"><span data-stu-id="d063a-127">The string table and the Resource Records share the service cache.</span></span> <span data-ttu-id="d063a-128">Os Registos de Recursos são armazenados desde o início da cache de serviço e crescem no final da cache.</span><span class="sxs-lookup"><span data-stu-id="d063a-128">Resource Records are stored from the beginning of the service cache, and grow towards the end of the cache.</span></span> <span data-ttu-id="d063a-129">A mesa de cordas começa a partir do fim da cache de serviço e cresce para o início da cache.</span><span class="sxs-lookup"><span data-stu-id="d063a-129">The string table starts from the end of the service cache and grows towards the beginning of the cache.</span></span> <span data-ttu-id="d063a-130">Cada corda na mesa de cordas tem um campo de comprimento e um contra-campo.</span><span class="sxs-lookup"><span data-stu-id="d063a-130">Each string in the string table has a length field and a counter field.</span></span> <span data-ttu-id="d063a-131">Quando uma corda é adicionada à tabela de cordas, se a mesma corda já estiver presente na tabela, o valor do contador é incrementado e nenhuma memória é atribuída para a cadeia.</span><span class="sxs-lookup"><span data-stu-id="d063a-131">When a string is added to the string table, if the same string is already present in the table, the counter value is incremented and no memory is allocated for the string.</span></span> <span data-ttu-id="d063a-132">A cache de serviço é considerada completa se não puderem ser adicionados mais registos de recursos ou novas cordas à cache de serviço.</span><span class="sxs-lookup"><span data-stu-id="d063a-132">The service cache is considered full if no more resource records or new strings can be added to the service cache.</span></span>

<span data-ttu-id="d063a-133">Existem duas formas de uma aplicação para encontrar serviços oferecidos na rede local.</span><span class="sxs-lookup"><span data-stu-id="d063a-133">There are two ways for an application to find services offered on the local network.</span></span> <span data-ttu-id="d063a-134">Pode emitir um serviço específico através de uma consulta de um tiro, ou pode iniciar uma consulta contínua para "monitorizar" as atividades na rede.</span><span class="sxs-lookup"><span data-stu-id="d063a-134">It can either issue a specific service look up through a one-shot query, or it can initiate a continuous query to “monitor” the activities on the network.</span></span> <span data-ttu-id="d063a-135">No cenário de consulta de um curto prazo, a aplicação deve especificar o tipo de serviço.</span><span class="sxs-lookup"><span data-stu-id="d063a-135">In the one-short query scenario, the application must specify the service type.</span></span> <span data-ttu-id="d063a-136">mDNS procura através da cache de serviço local e da cache de serviço de pares.</span><span class="sxs-lookup"><span data-stu-id="d063a-136">mDNS searches through the local service cache and the peer service cache.</span></span> <span data-ttu-id="d063a-137">Se estiver em casos de serviço, a consulta de um tiro retorna com as informações encontradas nos Registos de Recursos.</span><span class="sxs-lookup"><span data-stu-id="d063a-137">If a service instances is located, the one-shot query returns with the information found in the Resource Records.</span></span> <span data-ttu-id="d063a-138">Se não houver registos na cache de serviço local ou na cache de serviço de pares, o mDNS envia mensagens de consulta.</span><span class="sxs-lookup"><span data-stu-id="d063a-138">If there are no records in the local service cache or peer service cache, mDNS sends out query messages.</span></span> <span data-ttu-id="d063a-139">Se o nome da instância for especificado, um tipo *QUALQUER* (consulta do tipo SRV e TXT) com o nome de instância específica, sob a forma de "name.type.local", é enviado para a rede local.</span><span class="sxs-lookup"><span data-stu-id="d063a-139">If the instance name is specified, an *ANY* type (query the SRV and TXT type) with the specific instance name, in the form of “name.type.local”, is sent to the local network.</span></span> <span data-ttu-id="d063a-140">Se o nome da instância não for especificado, é enviado um tipo de consulta PTR para a rede local.</span><span class="sxs-lookup"><span data-stu-id="d063a-140">If the instance name is not specified, a PTR type of query is sent to the local network.</span></span> <span data-ttu-id="d063a-141">O primeiro serviço completo recebido é devolvido ao chamador.</span><span class="sxs-lookup"><span data-stu-id="d063a-141">The first complete service received is returned to the caller.</span></span>

<span data-ttu-id="d063a-142">A consulta contínua funciona de forma diferente.</span><span class="sxs-lookup"><span data-stu-id="d063a-142">Continuous query works differently.</span></span> <span data-ttu-id="d063a-143">O caso típico de utilização para uma consulta contínua é monitorizar a rede local para um serviço específico (por exemplo, procurar constantemente serviços de impressão na rede local).</span><span class="sxs-lookup"><span data-stu-id="d063a-143">The typical use case for a continuous query is to monitor the local network for a specific service (for example to constantly look for printing services on the local network).</span></span> <span data-ttu-id="d063a-144">Neste caso, a aplicação emite uma consulta de pesquisa (através da consulta *nx_mdns_service_continious_* API) para determinado tipo de serviços.</span><span class="sxs-lookup"><span data-stu-id="d063a-144">In this case the application issues a search query (via the API *nx_mdns_service_continious_* query) for certain type of services.</span></span> <span data-ttu-id="d063a-145">Normalmente, o chamador não espera por uma resposta específica.</span><span class="sxs-lookup"><span data-stu-id="d063a-145">The caller typically does not wait for a particular response.</span></span> <span data-ttu-id="d063a-146">Para consultas submetidas como consulta contínua, o módulo mDNS transmite periodicamente as consultas com intervalos exponencialmente crescentes.</span><span class="sxs-lookup"><span data-stu-id="d063a-146">For queries submitted as continuous query, the mDNS module transmits the queries periodically with exponentially increasing intervals.</span></span> <span data-ttu-id="d063a-147">Para parar a consulta, a aplicação deve utilizar o *nx_mdns_service_query_stop* da API para parar o temporizador interno nestas consultas.</span><span class="sxs-lookup"><span data-stu-id="d063a-147">To stop the query, application must use the API *nx_mdns_service_query_stop* to stop the internal timer in these queries.</span></span> <span data-ttu-id="d063a-148">O tipo de consulta pode ser NU, caso em que o tipo de consulta é definido para o tipo de PTR especial "_services._dns-sd._udp.local".</span><span class="sxs-lookup"><span data-stu-id="d063a-148">The query type can be NULL, in which case the query type is set to special PTR type “_services._dns-sd._udp.local”.</span></span> <span data-ttu-id="d063a-149">Este tipo de serviço é definido pelo mDNS como uma forma de descobrir todos os serviços disponíveis na rede local.</span><span class="sxs-lookup"><span data-stu-id="d063a-149">This service type is defined by mDNS as a way to discover all services available on the local network.</span></span> <span data-ttu-id="d063a-150">Se o nome da instância for fornecido, é enviado para a rede local um tipo QUALQUER (consulta do tipo SRV e TXT) com o nome de instância específica "name.type.local".</span><span class="sxs-lookup"><span data-stu-id="d063a-150">If the instance name is supplied, an ANY type (query the SRV and TXT type) with the specific instance name “name.type.local” is sent to the local network.</span></span> <span data-ttu-id="d063a-151">Se o nome da instância for NU, é enviado um tipo de consulta PTR para a rede local,</span><span class="sxs-lookup"><span data-stu-id="d063a-151">If the instance name is NULL, a PTR type of query is sent to the local network,</span></span>

<span data-ttu-id="d063a-152">Todas as respostas, incluindo respostas de consultas não solicitadas, são registadas na cache de serviço de pares.</span><span class="sxs-lookup"><span data-stu-id="d063a-152">All responses, including responses from unsolicited queries, are recorded in the peer service cache.</span></span> <span data-ttu-id="d063a-153">Posteriormente, a aplicação utiliza a *API nx_mdns_service_lookup* para recuperar o serviço específico a partir da cache de serviço de pares.</span><span class="sxs-lookup"><span data-stu-id="d063a-153">At a later time, the application uses the API *nx_mdns_service_lookup* to retrieve specific service from the peer service cache.</span></span>

<span data-ttu-id="d063a-154">Nota especial sobre fragmentação: Cada *NX_MDNS_RR* estrutura é fixada em tamanho, pelo que não está sujeita a fragmentação à medida que o mDNS adiciona e elimina rrs.</span><span class="sxs-lookup"><span data-stu-id="d063a-154">Special note on fragmentation: Each *NX_MDNS_RR* structure is fixed in size, and therefore is not subject to fragmentation as mDNS adds and deletes RRs.</span></span> <span data-ttu-id="d063a-155">No entanto, as cordas têm um comprimento variável.</span><span class="sxs-lookup"><span data-stu-id="d063a-155">However strings are variable length.</span></span> <span data-ttu-id="d063a-156">Depois de uma corda ser eliminada, o espaço fica disponível e pode ser usado para uma nova corda se a nova corda for capaz de se encaixar.</span><span class="sxs-lookup"><span data-stu-id="d063a-156">After a string is deleted, the space becomes available and could be used for a new string if the new string is able to fit in.</span></span> <span data-ttu-id="d063a-157">Mas esta operação faz com que a memória se fragmente.</span><span class="sxs-lookup"><span data-stu-id="d063a-157">But this operation causes the memory to fragment.</span></span> <span data-ttu-id="d063a-158">À medida que os serviços são adicionados e removidos, a tabela de cordas pode ser fragmentada ao ponto de não serem adicionadas novas cordas, mesmo que a cache de serviço contenha bytes não reutilizados suficientes para a cadeia.</span><span class="sxs-lookup"><span data-stu-id="d063a-158">As services are added and removed, the string table may be fragmented to the point that no new strings can be added even though the service cache contains enough unused bytes for the string.</span></span> <span data-ttu-id="d063a-159">As aplicações locais tendem a ser mais estáveis e previsíveis.</span><span class="sxs-lookup"><span data-stu-id="d063a-159">Local applications tend to be more stable and predictable.</span></span> <span data-ttu-id="d063a-160">Portanto, a cache de serviço local é menos suscetível de sofrer de fragmentação.</span><span class="sxs-lookup"><span data-stu-id="d063a-160">Therefore the local service cache is less likely to suffer from fragmentation.</span></span> <span data-ttu-id="d063a-161">A cache de serviço por pares, por outro lado, adiciona constantemente RRs à medida que os serviços ficam disponíveis, ou remove rrs à medida que os serviços são eliminados pelos nós na rede.</span><span class="sxs-lookup"><span data-stu-id="d063a-161">The peer service cache, on the other hand, constantly add RRs as the services become available, or remove RRs as services are deleted by the nodes on the network.</span></span> <span data-ttu-id="d063a-162">Os serviços na rede vêm e vão, causando operações mais frequentes de atribuição/eliminação na tabela de cordas.</span><span class="sxs-lookup"><span data-stu-id="d063a-162">Services on the network come and go, causing more frequent allocate/delete operations on the string table.</span></span> <span data-ttu-id="d063a-163">Com o tempo é possível que a mesa de cordas se fragmente.</span><span class="sxs-lookup"><span data-stu-id="d063a-163">Over time it is possible the string table becomes fragmented.</span></span> <span data-ttu-id="d063a-164">Quando esta situação acontece, uma solução simples é lavar toda a cache de serviço de pares.</span><span class="sxs-lookup"><span data-stu-id="d063a-164">When this situation happens, a simple solution is to flush the entire peer service cache.</span></span> <span data-ttu-id="d063a-165">Isto pode ser feito chamando a API *nx_mdns_peer_cache_clear().*</span><span class="sxs-lookup"><span data-stu-id="d063a-165">This can be done by calling the API *nx_mdns_peer_cache_clear().*</span></span> <span data-ttu-id="d063a-166">Note que esta API termina automaticamente quaisquer consultas contínuas pendentes.</span><span class="sxs-lookup"><span data-stu-id="d063a-166">Note that this API automatically terminates any outstanding continuous queries.</span></span>
